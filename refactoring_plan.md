# 프로세스 관리 시스템 리팩토링 계획

## 문제 개요

현재 프로세스 관리 시스템은 다음과 같은 주요 문제점이 있습니다:

1. **상태 관리 중복**: ProcessComponent와 Orchestrator가 동시에 상태 관리
2. **책임 경계 불명확**: 각 컴포넌트의 역할과 책임이 혼재
3. **중복 로깅**: 상태 변경 시 여러 곳에서 같은 내용 로깅
4. **상태 변경 경로 복잡**: 여러 메서드를 통한 상태 변경으로 일관성 부족

## 개선 목표

1. **명확한 책임 분리**: 각 컴포넌트가 단일 책임만 가지도록 함
2. **상태 관리 일원화**: 상태 변경과 이벤트 발행의 중복 제거
3. **일관된 인터페이스**: 모든 프로세스 컴포넌트가 동일한 패턴으로 동작
4. **중복 로깅 제거**: 상태 변경 시 한 번만 로깅하도록 개선

## 수정 계획 (바텀업 접근)

### 1. 프로세스 컴포넌트 (process_component.py)

#### 현재 문제점
- 상태 관리와 이벤트 발행이 혼재되어 있음
- 중복 상태 변경 경로(`_start_process()`, `set_running()` 등)
- 상태 변경 로직이 복잡함

#### 개선 방안
1. **단일 상태 관리 지점 마련**
   - 모든 상태 변경을 `_update_status()` 메서드로 일원화
   - 상태 변경 시 단 한 번만 이벤트 발행

2. **명확한 상태 전이 정의**
   - 상태 전이 규칙 명시 (어떤 상태에서 어떤 상태로 전이 가능한지)
   - 잘못된 상태 전이 방지 로직 추가

3. **템플릿 메서드 패턴 강화**
   - `start()`, `stop()` 등 추상 메서드의 구현 가이드라인 명확화
   - 표준 생명주기 관리 (초기화 → 시작 → 실행 → 중지)

#### 구체적 변경 사항
- `_update_status(status, error_message=None)` 메서드 신설
- `set_running()` 메서드 제거 또는 `_update_status()`로 리디렉션
- 이벤트 발행 로직을 `_update_status()` 내부로 이동
- 상태 변경 로깅 단순화

### 2. 오더북 핸들러 (orderbook_handler.py)

#### 현재 문제점
- `is_running` 변수가 중복 관리됨 (ProcessComponent의 status와 별개로)
- 상태 관리 책임이 불명확

#### 개선 방안
1. **부모 클래스 상태 활용**
   - 독자적인 `is_running` 변수 제거
   - ProcessComponent의 status 필드 활용

2. **명확한 결과 전달**
   - OrderbookCollector 호출 결과를 명확히 확인하여 상태 변경

#### 구체적 변경 사항
- `is_running` 변수 제거
- start/stop 메서드에서 부모 클래스의 상태 관리 메서드만 사용
- 오류 처리 로직 개선 (오류 메시지 명확화)

### 3. 오더북 콜렉터 (ob_collector.py) 

#### 현재 문제점
- `set_running()` 메서드 직접 호출로 상태 관리 규칙 우회
- 비즈니스 로직과 상태 관리 혼합

#### 개선 방안
1. **상태 관리 위임**
   - 직접 상태 변경하지 않고, 성공/실패 결과만 반환
   - 실제 상태 관리는 OrderbookProcess가 담당

2. **비즈니스 로직 집중**
   - 웹소켓 연결, 구독 등 핵심 비즈니스 로직에만 집중
   - 성공/실패 여부를 명확히 반환

#### 구체적 변경 사항
- `set_running()` 직접 호출 제거
- 상태 변경 로직 제거 또는 수정
- 성공/실패 판단 로직 개선

### 4. 이벤트 버스 (system_event_bus.py)

#### 현재 문제점
- 이벤트 발행 시 메타데이터 처리 복잡
- 컴포넌트 식별 로직이 불명확

#### 개선 방안
1. **단순화된 인터페이스**
   - 이벤트 발행 메서드 간소화
   - 메타데이터 구조 일관화

2. **명확한 이벤트 식별**
   - 이벤트 소스, 타입, 토픽에 대한 명확한 규칙 수립

#### 구체적 변경 사항
- `publish()` 메서드 인터페이스 단순화
- 메타데이터 처리 로직 개선
- 불필요한 조건부 로직 제거

### 5. 오케스트레이터 (orchestrator.py)

#### 현재 문제점
- 프로세스 상태 중복 관리 (`running_processes` 집합)
- 과도한 로깅 및 상태 변경 책임

#### 개선 방안
1. **상태 추적만 담당**
   - 프로세스 상태 변경 요청만 전송
   - 실제 상태 관리는 ProcessComponent에 위임

2. **중복 로깅 방지**
   - 이미 동일한 상태일 경우 로깅 생략
   - 상태 변화 시에만 의미있는 로깅

3. **프로세스 조율에 집중**
   - 프로세스 의존성 관리
   - 시스템 전체 시작/종료 순서 조율

#### 구체적 변경 사항
- `_handle_process_status()` 메서드에서 중복 상태 확인 로직 추가
- 불필요한 로깅 제거
- `running_processes` 사용 방식 수정 (읽기 전용으로)

### 6. 텔레그램 커맨더 (telegram_commander.py)

#### 현재 문제점
- ProcessComponent 상속 없이 자체 상태 관리
- 시스템 다른 부분과 일관성 부족

#### 개선 방안
1. **ProcessComponent 상속 고려**
   - 프로세스 관리 일관성 확보
   - 상태 관리 표준화

2. **명령 전송 표준화**
   - 명확한 명령 전송 및 응답 처리
   - 오류 처리 일관화

#### 구체적 변경 사항
- ProcessComponent 상속 구현 또는 인터페이스 일관화
- 상태 관리 방식 통일
- 명령 처리 응답 표준화

## 구현 순서 및 접근 방식

1. **process_component.py 먼저 수정**
   - 모든 프로세스의 기반이 되는 클래스이므로 가장 먼저 수정
   - 상태 관리 로직 일원화 및 인터페이스 간소화

2. **orderbook_handler.py 수정**
   - 수정된 ProcessComponent 활용
   - 중복 상태 관리 제거

3. **ob_collector.py 수정**
   - 비즈니스 로직에 집중
   - 불필요한 상태 관리 로직 제거

4. **system_event_bus.py 수정**
   - 이벤트 발행 인터페이스 단순화
   - 메타데이터 처리 개선

5. **orchestrator.py 수정**
   - 상태 수신 및 추적 로직 개선
   - 중복 로깅 제거

6. **telegram_commander.py 수정**
   - 일관된 인터페이스 적용
   - 명령 처리 표준화

## 테스트 전략

각 모듈 수정 후 다음 테스트를 진행합니다:

1. **단위 테스트**
   - 각 컴포넌트의 독립적 기능 검증
   - 특히 상태 변경 및 이벤트 발행 테스트

2. **통합 테스트**
   - 컴포넌트 간 상호작용 검증
   - 전체 생명주기 시나리오 테스트

3. **회귀 테스트**
   - 기존 기능이 정상 동작하는지 확인
   - 특히 프로세스 시작/중지/재시작 테스트

## 예상 효과

1. **코드 품질 향상**
   - 책임 분리로 코드 가독성 및 유지보수성 증가
   - 중복 코드 제거로 버그 발생 가능성 감소

2. **확장성 개선**
   - 새로운 프로세스 추가가 용이해짐
   - 일관된 인터페이스로 통합 단순화

3. **로깅 최적화**
   - 의미 있는 로그만 기록하여 디버깅 용이
   - 중복 로깅 제거로 로그 가독성 향상

4. **신뢰성 향상**
   - 상태 관리 일관성으로 예측 가능한 동작
   - 오류 상황 처리 개선 