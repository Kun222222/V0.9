# 교차 김치 프리미엄 차익거래 실시간 계산 로직 설계

## 전략 개요

교차 **김치 프리미엄** 차익거래는 국내 거래소와 해외 거래소 간의 가격 차이를 이용하여 **무위험 수익**을 얻는 전략입니다. 이 전략에서는 두 종류의 암호화폐를 사용합니다:
- **전송코인**: 국내에서 해외로 가치 이동에 사용
- **수익코인**: 해외에서 국내로 가져와 프리미엄을 실현

두 코인의 흐름을 분리하여 각각 헤지(hedge)함으로써 가격 변동 위험을 최소화합니다. 각 단계에서 필요한 KRW와 USDT는 미리 준비되어 있어 **환전 과정 없이** 진행됩니다. 모든 가격은 실시간 **USDT/KRW 환율**을 기준으로 KRW 값으로 통일하여 비교합니다.

---

## 전송 코인 경로: 국내 → 해외 자금 이동 (KRW → USDT)

전송코인 경로는 **국내 자산을 해외 자산(USDT)**으로 바꾸는 흐름입니다. 국내 거래소에서 전송코인을 매수하고 해외로 송금하며, 동시에 해외 거래소에서 해당 전송코인을 공매도하여 가격 변동을 헤지합니다.

> **예시:** 전송코인으로 XRP를 선택했다면 업비트에서 XRP를 매수한 뒤 바이낸스로 전송하고, 전송되는 동안 바이낸스에서 같은 양의 XRP를 미리 대출(마진 숏)하여 매도합니다.

### 주요 단계

1. **국내 전송코인 매수:**
   - 국내 거래소(업비트 또는 빗썸)에서 전송코인을 시장가로 매수
   - 예: 10,000만 원 상당의 XRP 매수
   - **국내 매수 수수료**(0.05~0.1%) 발생
   - **출금 수수료** 고려하여 여유 있게 추가 매수 (예: XRP 출금 수수료 10 XRP)

2. **해외 거래소에서 전송코인 공매도(헤지):**
   - 국내 매수 직후, **해외 거래소(바이낸스/바이빗)**에서 동일 수량을 **마진 거래로 대출 후 즉시 매도**
   - 예: 업비트에서 15,000 XRP 매수/출금 → 바이낸스에서 15,000 XRP 대출하여 매도
   - **해외 매도 수수료**(~0.1%) 발생, 매도 대금으로 **USDT** 확보
   - 레버리지 활용 가능하나, 충분한 증거금 USDT 유지 필요

3. **코인 전송 및 대출 상환:**
   - 국내에서 전송한 코인이 **해외 거래소 지갑에 도착**하면 공매도 포지션 청산
   - **반환**(마진 대출 상환)으로 숏 포지션 종료
   - 10~20분 이내 단기 대출로 **이자 비용 무시**
   - 가격 변동 위험 헤지 완료

### 전송코인 경로 수익/비용 계산

전송코인 경로를 통해 **KRW → USDT 환전**이 이뤄집니다. 효과적인 환율과 비용 계산을 위해 **전송코인 경로 수익률** $R_T$를 정의합니다:

$$R_T = \frac{\text{해외에서 확보한 USDT}}{\text{국내에서 사용한 KRW}}$$

전송코인 경로에서 국내 1 KRW로 얻은 USDT 비율을 나타냅니다. 이상적인 기준환율은 $1\text{KRW} = \frac{1}{E}\text{USDT}$ ($E$는 실시간 USDT/KRW 환율)이지만, 실제 $R_T$는 각종 비용과 가격 차이를 반영합니다.

#### $R_T$ 계산 시 고려 요소:

| 요소 | 설명 |
|------|------|
| **국내 매수가격** | 전송코인 국내 매수 평균단가 (KRW) |
| **국내 수수료** | 매수금액의 ~0.05% (실질 지출 KRW 증가) |
| **해외 매도가격** | 전송코인 해외 공매도 가격 (USDT) |
| **해외 수수료** | 매도금액의 ~0.1% (실질 확보 USDT 감소) |
| **출금 수수료** | 전송코인 출금 시 차감되는 코인 수량 |

이 요소들을 반영하여 $R_T$를 계산하면 **전송코인 경로의 순환환율**을 얻습니다.

> **예시 계산:** 10,000,000 KRW로 XRP를 매수/전송하여 해외에서 7,700 USDT를 확보했다면 $R_T = 7,700/10,000,000 \approx 0.00077\ \text{USDT/KRW}$입니다. 이는 약 1298 KRW/USDT에 해당합니다.

$R_T$가 $\frac{1}{E}$보다 높으면(전송코인 경로가 직접 환전 대비 이득) 추가 수익에 기여하며, 낮으면 비용으로 작용합니다.

### 전송코인 경로 리스크

이 경로는 **국내 자산→해외 자산 이동**이 목적이므로, 가격 변동 리스크는 공매도로 대부분 제거됩니다. 남은 리스크:
- 네트워크 전송 지연이나 실패
- **전송코인 가격의 국내-해외 가격차 변화**
- 레버리지 사용 시 마진콜 가능성 (단, 충분한 증거금과 짧은 시간으로 위험 통제)

요약하면, 전송코인 경로의 주요 비용은 수수료 형태로 고정되고, 가격 위험은 헤지로 제거되어 **환율 효율($R_T$)**만이 이익에 영향을 줍니다.

---

## 수익 코인 경로: 해외 → 국내 자금 이동 (USDT → KRW)

수익코인 경로는 해외의 USDT를 국내 KRW로 **회수하면서 프리미엄 차익**을 실현하는 흐름입니다. 해외 거래소에서 수익코인을 매수하여 국내로 송금하고, 도착한 코인을 국내 거래소에서 매도함으로써 국내 프리미엄을 얻습니다.

> **예시:** 수익코인으로 비트코인(BTC)을 선택했다면, 바이낸스에서 BTC를 USDT로 매수한 후 바로 동일 수량의 BTC를 선물시장에 숏하고, BTC를 국내로 전송합니다.

### 주요 단계

1. **해외 수익코인 매수:**
   - 해외 거래소의 현물마켓에서 수익코인을 USDT로 시장가 매수
   - 예: 7,700 USDT로 BTC 매수
   - **해외 매수 수수료**(~0.1%) 발생
   - 출금 수수료 고려하여 추가 매수 (예: BTC 출금 수수료 0.0005 BTC)

2. **해외 선물 숏 헤지:**
   - 매수 직후 **해외 선물 거래소**에서 동일 수량 **선물 숏 포지션** 구축
   - 예: 매수한 0.2 BTC에 대해 0.2 BTC의 perpetual 선물 숏 오픈
   - 현물-선물 가격 변동 상쇄로 헤지 효과
   - **선물 거래 수수료**(왕복 ~0.04-0.1%) 발생
   - 짧은 보유로 **펀딩비 등의 비용은 무시** 가능

3. **코인 전송:**
   - 해외에서 매수한 수익코인을 국내 거래소 지갑으로 **출금 전송**
   - 예: 0.2005 BTC 출금 → 수수료 0.0005 BTC 제외 → **0.20 BTC 국내 도착**
   - 전송 시간은 약 20분 가정

4. **국내 수익코인 매도 및 헤지 마무리:**
   - 수익코인 도착 즉시 **시장가 매도** 실행
   - 국내 KRW 마켓에 판매하여 현금 확보
   - **국내 매도 수수료**(~0.05-0.1%) 차감
   - 해외 선물 숏 포지션 **매수 청산**으로 종료
   - 결과적으로 해외-국내 가격차(김치 프리미엄)만 실현

### 수익코인 경로 수익/비용 계산

수익코인 경로는 **USDT → KRW 환전**에 해당하며, **수익코인 경로 수익률** $R_P$를 다음과 같이 정의합니다:

$$R_P = \frac{\text{국내에서 회수한 KRW}}{\text{해외에서 사용한 USDT}}$$

해외 1 USDT를 투입하여 국내에서 얻은 KRW 비율입니다. 기본 환율은 $1\text{USDT} = E\text{KRW}$이나, 김치 프리미엄이 있다면 $R_P$는 $E$보다 높게 형성됩니다.

#### $R_P$ 계산 시 고려 요소:

| 요소 | 설명 |
|------|------|
| **해외 매수가격** | 수익코인 해외 매수 평균단가 (USDT) |
| **해외 수수료** | 매수 금액의 ~0.1% (실제 코인 수량 감소) |
| **출금 수수료** | 해외 코인 출금 시 차감되는 코인 수량 |
| **국내 매도가격** | 수익코인 국내 매도 평균단가 (KRW) |
| **국내 수수료** | 매도 금액의 ~0.05% (최종 KRW 감소) |

> **예시 계산:** 해외에서 7,700 USDT로 BTC를 구매/전송하여 국내에서 10,050만 KRW를 확보했다면, $R_P = 10,050만 / 7,700 \approx 1305.19\ \text{KRW/USDT}$가 됩니다.

이 값이 실시간 환율 $E$보다 높으면 프리미엄 차익이 있다는 뜻입니다. 두 코인 경로 완료 시 **최종 이익은 $R_T$와 $R_P$의 곱으로 결정**됩니다.

### 수익코인 경로 리스크

수익코인 경로에서도 **가격 변동 위험은 선물 숏 헤지**로 대부분 제거됩니다. 남은 주요 위험:
- **국내 프리미엄 변동** (전송 중 프리미엄 하락 시 이익 감소)
- 선물 헤지는 글로벌 가격 변동만 커버, 한국 시장 프리미엄 변동은 헤지 불가
- 전송 지연 또는 입출금 지연

리스크 완화 방법:
- **최소 수익률 요건**(0.1%) 설정으로 안전마진 확보
- 전송속도 빠른 코인/네트워크 선택
- **충분한 자본 버퍼** 유지

---

## 수익률 계산 및 환율 통일 기준

두 경로 합산 시 **KRW → USDT → KRW** 순환이 완성되며, 김치 프리미엄에 따른 차익이 발생합니다.

### 통합 수익률 계산

- **통합 수익률 (배수)** = $R_T \times R_P$
- **통합 이익률 (%)** = $(R_T \times R_P - 1) \times 100\%$

여기서 $R_T = \frac{\text{USDT_out}}{\text{KRW_in}}$, $R_P = \frac{\text{KRW_out}}{\text{USDT_in}}$이며, 이상적으로 $\text{USDT_out} = \text{USDT_in}$일 때 성립합니다.

### USDT/KRW 환율 통일

실시간으로 **업비트/빗썸의 USDT-KRW 마켓 가격**을 환율 $E$로 사용하여 국내외 가격을 같은 기준으로 비교합니다.

#### 간단 검증 방법
- **수익코인 국내가격** vs **수익코인 해외가격×$E$** 비교
- **전송코인 국내가격** vs **전송코인 해외가격×$E$** 비교

> **예시:**
> - BTC 국내가격 = 40,000,000 KRW, BTC 해외가격 = 30,000 USDT, $E = 1300$ KRW/USDT
> - BTC의 KRW환산 해외가격 = 39,000,000 KRW → **김치 프리미엄 약 2.56%**
> - XRP 국내가격 = 500 KRW, XRP 해외가격 = 0.38 USDT
> - XRP KRW환산 해외가격 = 494 KRW → **국내 XRP 프리미엄 1.2%**
> - 실제 계산: $R_T \approx \frac{(0.38 \times (1-0.001))}{(500 \times (1+0.001))}$, $R_P \approx \frac{(40,000,000 \times (1-0.0005))}{(30,000 \times (1+0.001))}$
> - 두 값을 곱한 후 -1 하면 수익률% 산출

### 수익률 기준

실시간 계산을 통해 **예상 수익률이 0.1% (0.001 배) 이상**이면 해당 **교차 차익거래 조합을 실행**합니다. 0.1% 미만은 실익이 없어 트리거하지 않습니다.

---

## 거래 경로별 비용 요소 및 리스크 요약

### 전송코인 경로 (국내 → 해외 환전)

#### 절차
국내 KRW로 전송코인 매수 → 코인 해외송금 → 해외에서 동일 코인 공매도 후 도착 시 상환.

#### 비용 요소
- 국내 매수 수수료 (KRW 기반, ~0.05-0.1%)
- 해외 매도 수수료 (USDT 기반, ~0.1%)
- 출금 수수료 (코인 수량 고정)
- 숨은 비용: 호가 스프레드 및 슬리피지

#### 성과 지표
$R_T$ (전송환율 효율) – 국내 1 KRW로 얻은 USDT 비율

#### 리스크
- 전송 지연/실패
- 국내-해외 해당 코인 가격차 변화
- 유동성 부족으로 인한 슬리피지
- 전체적으로 변동성 위험은 낮음

### 수익코인 경로 (해외 → 국내 환전)

#### 절차
해외 USDT로 수익코인 매수 → 수익코인 해외송금 → 국내 도착 즉시 매도 (KRW 획득) → 해외 선물 숏 포지션 청산.

#### 비용 요소
- 해외 매수 수수료 (USDT 기반, ~0.1%)
- 해외 선물 거래 수수료 (왕복 0.04-0.1%)
- 출금 수수료 (코인 수량 고정)
- 국내 매도 수수료 (KRW 기반, ~0.05%)
- 추가 비용: 호가 스프레드 및 슬리피지

#### 성과 지표
$R_P$ (프리미엄 환전 효율) – 해외 1 USDT로 얻은 KRW 비율

#### 리스크
- 국내 프리미엄 변동 위험
- 시장 임팩트 위험 (동시 다량 실행 시)
- 전송 지연 시 선물 포지션 보유 시간 증가
- 증거금 관리 필요

---

## 실시간 데이터 수집 및 계산 트리거 구조

이 전략은 **실시간**으로 다수 거래소 가격을 모니터링하고 신속하게 기회를 포착해야 합니다.

### 데이터 수집
- 4개 거래소(업비트, 빗썸, 바이낸스, 바이빗)의 현물 및 선물 **오더북** 구독
- 초당 1000~3000건의 이벤트 처리 능력 필요

### 주요 설계 요소

#### 오더북 데이터 구조
- 거래소별/코인별 오더북 객체 유지 (예: OrderBook[업비트][BTC])
- **호가 누적 캐시**로 시장가 주문 예상 체결가 실시간 계산
- 1천만원/7700 USDT 규모 주문의 체결 가격 실시간 추정

#### 이벤트 기반 계산 트리거
- 새 오더북 데이터 입수 시 **관련 조합만 계산**하여 효율화
- 업데이트 코인이 전송코인 목록에 속하면 해당 $R_T$ 재계산
- 업데이트 코인이 수익코인 목록에 속하면 해당 $R_P$ 재계산
- USDT/KRW 환율 업데이트 시 $E$ 갱신

#### 캐시 및 조합 최적화
- 전송코인/수익코인 후보 미리 선정 (예: 전송코인 5종, 수익코인 5종)
- **조합 스코어링**: $Score(i,j) = R_T[i] \times R_P[j] - 1$
- 0.1% 임계치 초과 조합만 별도 관리

#### 병렬 처리
- 각 거래소 데이터 스트림을 개별 소비자 스레드가 처리
- 중앙 **계산 스레드**가 $R_T$, $R_P$ 값 원자적 갱신
- **락/쓰레드 안전** 유지, lock-free 구조 사용
- 이벤트 큐 또는 tick당 한 번 처리로 중복 계산 방지

#### 실시간 통합
- 계산된 값들을 UI/로그로 모니터링
- **자동 매매 트리거 모듈**에 입력
- 중요 조합 별도 추적 및 알림
- 최근 추이 등 데이터 캐싱으로 분석 지원

---

## 조합 선정 및 매매 실행 트리거

실시간 계산된 모든 코인 조합에 대한 수익률 스코어를 기준으로 매매를 결정합니다.

### 의사결정 로직

#### 임계치 필터
- $Score(i,j) = R_T[i] \times R_P[j] - 1 \ge 0.0010$ (≥0.1%) 조합 선정
- 조건 처음 충족 시 **트리거 발생**으로 간주
- 이미 진행 중인 조합은 추가 트리거 보류

#### 우선순위 결정
- 여러 조합 동시 발견 시 **수익률 높은 순** 우선 실행
- 충분한 자금 시 **복수 조합 병렬 실행** 가능
- 자금 제약 시 높은 수익률 조합 우선

### 매매 트리거 세부 절차

1. **호가 재확인**
   - 트리거 시점 최신 호가 다시 확인
   - **사전 호가 잠금** 또는 **TLV** 방식 안전장치

2. **동시 주문 실행**
   - 전송코인 국내 매수 + 수익코인 해외 매수 거의 동시 실행
   - 이어서 전송코인 해외 숏 + 수익코인 선물 숏 실행
   - 멀티스레드/비동기 호출로 시간차 최소화

3. **체결 확인 및 수량 정리**
   - 체결된 수량으로 정확한 전송 수량과 포지션 규모 계산
   - 전송 수수료 고려한 출금 요청
   - 헤지 포지션 수량 조정으로 완벽 매칭

4. **상태 기록**
   - 거래 정보 시스템에 기록 (조합, 이익률, 자금, 가격, 수수료 등)
   - 추적 및 디버깅 목적

### 자금 할당 및 락(lock)
- 거래에 필요한 자금 **예약/차감**
- 내부 **자금 풀** 관리로 진행 중 금액 사용 불가 표시
- 멀티스레드 환경에서 **뮤텍스/원자적 연산** 적용

---

## 자금 회전 및 동시 실행 계획

### 파이프라인 운영
- 1분 단위 실행, 20분 전송 지연, 8억원 버퍼 가정
- 첫 거래 자금 회수 전에도 새 거래 계속 시작
- steady-state에서 **최대 20건 미완료 거래** 동시 존재
- 파이프라인 방식으로 연속적 자금 순환

### 동시 실행 한도
- 8억원 버퍼는 1천만원×80건 커버 가능
- 20분 파이프라인(20건)에 4배 여유
- 여러 조합 동시 트리거도 충분히 처리
- 각 거래는 독립적 헤지로 간섭 없음
- 동일 코인 반복 사용은 제한 필요 (예: 동일 코인 최대 3건)

### 도착 및 청산 처리
- 각 거래 약 20분 후 전송 완료로 마무리
- **전송 완료 이벤트** 또는 타이머로 처리
- 마무리 절차: 마진 숏 상환, 국내 매도, 선물 포지션 청산
- 도착 지연 시 **보정 로직** 포함

### 자금 회수 및 재사용
- 거래 완료 시 KRW와 USDT 원래 계정으로 귀속
- 국내: 수익코인 매도 수익(이익 포함) 회수
- 해외: 전송코인 숏 상환 후 USDT 확보
- 시스템 자금풀에서 락 해제하여 **재투입** 가능하게 함

### 자금 회전 효율
- 1분에 1천만원씩 회전, 20분 후부터 매 분 결과 발생
- 20분간 누적 20건×0.1% = 2% 수익 발생 가능
- 8억원 병렬 활용 시 최대 매 분 800만원 이익 이론상 가능
- **자본 효율 극대화** 구조

### 모니터링 및 안전장치
- 각 거래별 타이머로 지연 감지
- **실시간 대시보드**로 상태 추적
- API 실패/지연 시 **신규 트리거 중단** 등 failsafe
- 이상 상황 자동 대응 메커니즘

---

## 정리 및 구현 시사점

본 설계는 **교차 김프 아비트라지**의 실시간 계산과 실행 로직을 상세히 다룹니다.

### 핵심 요소
- **전송코인/수익코인 경로 모듈화**로 $R_T$, $R_P$ 분리 계산
- **USDT/KRW 환율** 일원화로 국내외 가격 통일 비교
- **이벤트 기반, 캐시 최적화, 조합 스코어링** 로직
- 동시성 관리와 파이프라인 처리로 자금 효율 극대화

### 구현 시 고려사항
- 정수 기반 처리 또는 **소수점 오차 관리**
- 거래소 API 호출 지연 및 실패 재시도 로직
- 데이터 스트림 **로스 방지** 튜닝
- 실시간성과 안정성 균형을 위한 **임계값 조율**

### 코드 구조 제안
- `calculate_R_T(coin)`, `calculate_R_P(coin)`, `evaluate_scores()`, `execute_trade(pair)` 등 함수화
- 이벤트 루프 내 함수 호출 구조
- 멀티스레드 시 큐(queue)/Pub-Sub으로 이벤트 전달

이 설계를 바탕으로 세분화된 로직과 데이터 구조를 구현하면 실제 아비트라지 트레이딩 봇을 구축할 수 있습니다.