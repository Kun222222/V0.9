# 오더북 증분 업데이트 검증 도구

이 도구는 거래소에서 받은 오더북 데이터의 증분 업데이트(델타)가 정상적으로 적용되는지 검증하는 도구입니다.

## 주요 기능

1. **델타 검증**: 로그 파일에서 오더북 스냅샷과 델타 데이터를 읽어 올바르게 업데이트되는지 검증
2. **시퀀스 검증**: 메시지 시퀀스가 정상적으로 연속되는지 확인하고 누락된 시퀀스 감지
3. **가격 역전 검증**: 최고 매수가가 최저 매도가보다 높아지는 비정상적인 상황 감지
4. **시각화**: 시간에 따른 오더북의 변화와 비정상 현상을 그래프로 시각화

## 설치 방법

필요한 패키지 설치:

```bash
pip install matplotlib numpy
```

## 사용 방법

### 1. 단일 로그 파일 검증

```bash
python delta_validator.py /path/to/logfile.log --max-lines 100000 --symbols BTCUSDT,ETHUSDT
```

옵션:
- `--max-lines`: 검증할 최대 라인 수 (기본값: 전체)
- `--symbols`: 검증할 심볼 목록 (기본값: 모든 심볼)

### 2. 모든 거래소 로그 파일 검증

```bash
python validate_all.py --log-dir /path/to/logs --max-lines 100000 --symbols BTCUSDT,ETHUSDT --output results.json
```

옵션:
- `--log-dir`: 로그 파일이 있는 디렉토리 (기본값: src/logs/raw_data)
- `--max-lines`: 각 파일당 검증할 최대 라인 수 (기본값: 전체)
- `--symbols`: 검증할 심볼 목록 (기본값: 모든 심볼)
- `--output`: 결과를 저장할 JSON 파일 경로 (기본값: 현재 시간으로 생성된 파일명)

### 3. 오더북 데이터 시각화

```bash
python visualize_orderbook.py /path/to/logfile.log BTCUSDT --max-lines 100000 --output-dir ./results
```

옵션:
- `--max-lines`: 처리할 최대 라인 수 (기본값: 전체)
- `--output-dir`: 결과물을 저장할 디렉토리 (기본값: 화면에 표시)

## 예시 결과

### 델타 검증 보고서

```
---- binance 오더북 검증 보고서 ----

총 메시지: 5342
스냅샷: 45
델타: 5297
잘못된 델타: 0
심볼 수: 42
심볼 목록: ADA, ARK, AUCTION, ...

오류 요약:
검증 오류: 12
시퀀스 누락 심볼: 5
가격 역전 심볼: 0

시퀀스 누락 상세:
  BTC: 3건, 누락된 총 메시지: 15
    모든 갭: [(123456, 123458, 1), (234567, 234570, 2), (345678, 345691, 12)]
  ETH: 2건, 누락된 총 메시지: 8
    모든 갭: [(123456, 123460, 3), (234567, 234572, 5)]
```

### 시각화 결과

- 심볼별 매수/매도 가격 변화 그래프
- 심볼별 스프레드 변화 그래프
- 심볼별 호가 뎁스(깊이) 변화 그래프
- 오더북 스냅샷 JSON 데이터

## 문제 해결 방법

- **시퀀스 누락**: 네트워크 연결 안정성 확인, 웹소켓 연결 상태 확인, 재연결 로직 개선
- **가격 역전**: 오더북 업데이트 로직 확인, 특히 호가 삭제 부분 점검
- **잘못된 델타**: 메시지 파싱 로직 확인, 거래소별 델타 형식 검증

## 주의사항

- 로그 파일이 매우 큰 경우 `--max-lines` 옵션을 사용하여 일부만 처리하는 것이 좋습니다.
- 시각화 기능은 많은 메모리를 사용할 수 있으므로 적절한 심볼 필터링이 필요합니다.
- 각 거래소마다 오더북 데이터 형식이 다르므로 거래소별 특성을 고려해야 합니다. 