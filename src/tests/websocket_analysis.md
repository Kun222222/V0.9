# 웹소켓 모듈 분석 및 리팩토링 계획

## 1. 공통 구조 및 패턴 분석

| 항목       |                   설명                          | 중복 여부    | 개선 방향           | 
|----------|-------------------------------------------------|-----------|-------------------|
| 클래스 구조 | 모든 거래소별 웹소켓 클래스는 `BaseWebsocket` 상속      | -         | 템플릿 메서드 패턴 강화 |
| 초기화 패턴 | `super().__init__(settings, exchange_name)` 호출 | -         | 표준화된 초기화 프로세스 |
| 연결 패턴  | `connect` 메서드에서 웹소켓 연결 시도                  | 높음       | 공통 연결 로직 추상화 |
| 구독 패턴  | `subscribe` 메서드에서 심볼 목록 구독                 | 중간       | 구독 메커니즘 표준화 |
| 메시지 파싱 | `parse_message` 메서드에서 JSON 파싱               | 높음        | 파싱 프레임워크 개선 |
| 메시지 처리 | `handle_parsed_message` 메서드                   | 중간       | 처리 로직 표준화 |
| 시작/종료  | `start`/`stop` 메서드                            | 높음       | 생명주기 관리 통합 |

## 2. 중복 코드 분석

| 중복 영역  | 영향 받는 파일         | 중복 정도    | 개선 방안 |
|----------|---------------------|-----------|-----------|
| 연결 로직  | 모든 웹소켓 구현 파일    | 높음        | `BaseWebsocket`에 통합 |
| 구독 처리  | 모든 웹소켓 구현 파일    | 중간        | 템플릿 메서드 패턴 적용 |
| JSON 파싱 | 모든 웹소켓 구현 파일    | 높음        | 공통 파싱 유틸리티 개발 |
| 로깅 패턴  | 모든 웹소켓 구현 파일    | 높음        | 로깅 시스템 통합 |
| 핑/퐁 처리 | 대부분의 웹소켓 구현 파일 | 높음        | 공통 핑/퐁 메커니즘 개발 |
| 에러 처리  | 모든 웹소켓 구현 파일    | 높음        | 에러 처리 프레임워크 개발 |

## 3. 거래소별 특화 기능 비교

| 거래소 | 특화 기능 | 구현 파일 | 통합 가능성 |
|--------|-----------|-----------|-------------|
| 바이낸스 현물 | 스냅샷 요청, 델타 처리, 100ms 업데이트 | binance_s_ws.py | 높음 |
| 바이낸스 선물 | 스냅샷 요청, 델타 처리, 테스트넷 지원 | binance_f_ws.py | 높음 |
| 바이빗 현물 V1 | 핑/퐁(20초), 최대 10개 심볼 구독 | bybit_s_ws.py | V2로 통합 |
| 바이빗 현물 V2 | 개선된 연결/오류 처리, 핑/퐁(20초) | bybit_s_ws_v2.py | 기준 버전 |
| 바이빗 선물 V1 | 핑/퐁(20초), 스냅샷 요청 | bybit_f_ws.py | V2로 통합 |
| 바이빗 선물 V2 | 개선된 연결/오류 처리, 핑/퐁(20초) | bybit_f_ws_v2.py | 기준 버전 |
| 업비트 | KRW 마켓, 스냅샷 포함 요청, 핑/퐁(60초) | upbit_s_ws.py | 중간 |
| 빗썸 | KRW 마켓, 타임스탬프 시퀀스, 핑/퐁(30초) | bithumb_s_ws.py | 중간 |

## 4. 바이빗 V1과 V2 비교

| 항목 | V1 | V2 | 개선점 |
|------|-----|-----|--------|
| 기본 URL | wss://stream.bybit.com/v5/public/spot(linear) | 동일 | - |
| 핑/퐁 간격 | 20초 | 20초 | - |
| 구독 제한 | 최대 10개 심볼 | 최대 10개 심볼 | - |
| 초기 연결 | 기본 연결 로직 | 타임아웃 및 재시도 개선 | V2 채택 |
| 메시지 처리 | 기본 처리 로직 | 개선된 오더북 관리 | V2 채택 |
| 오류 처리 | 기본 오류 처리 | 상세한 로깅 및 복구 | V2 채택 |
| 코드 품질 | 기본 | 개선됨 | V2 채택 |

## 5. 웹소켓 매니저 분석

| 기능        | 현재 상태           | 문제점              | 개선 방향 |
|-----    -|-----------|--------|--------       ---|
| 거래소 관리   | 하드코딩된 클래스 맵 | 유연성 부족       | 상수로 이동, 동적 로딩 |
| 메시지 큐    | 단일 큐 처리       | 병목 가능성         | 비동기 처리 최적화 |
| 상태 모니터링 | 기본 구현          | 제한적 기능       | 모니터링 강화 |
| 메트릭 관리   | 복잡한 구현        | 유지보수 어려움   | 모듈화 및 단순화 |
| 에러 처리    | 기본 구현          | 복구 메커니즘 부족 | 자동 복구 기능 강화 |
| 메모리 관리   | 기본 구현         | 최적화 부족       | 메모리 사용량 최적화 |

## 6. 리팩토링 계획

### 6.1. 공통 모듈 개선

| 작업 | 우선순위 | 예상 소요 시간 | 담당 |
|------|----------|----------------|------|
| `BaseWebsocket` 연결 로직 표준화 | 높음 | 4시간 | - |
| 구독 메커니즘 추상화 | 높음 | 3시간 | - |
| 메시지 파싱 프레임워크 개선 | 높음 | 5시간 | - |
| 에러 처리 메커니즘 강화 | 높음 | 4시간 | - |
| 로깅 시스템 통합 | 중간 | 3시간 | - |
| 웹소켓 상태 관리 클래스 개선 | 중간 | 3시간 | - |
| 재연결 전략 개선 | 중간 | 2시간 | - |

### 6.2. 거래소별 구현 표준화

| 작업 | 우선순위 | 예상 소요 시간 | 담당 |
|------|----------|----------------|------|
| 템플릿 메서드 패턴 적용 | 높음 | 6시간 | - |
| 메시지 파싱 표준화 | 높음 | 5시간 | - |
| 오더북 관리 표준화 | 중간 | 4시간 | - |
| 거래소별 특화 로직 분리 | 중간 | 4시간 | - |

### 6.3. 바이빗 V2 통합

| 작업 | 우선순위 | 예상 소요 시간 | 담당 |
|------|----------|----------------|------|
| V1 코드 삭제 및 V2 이름 변경 | 높음 | 1시간 | - |
| 중복 코드 제거 및 통합 | 높음 | 3시간 | - |
| 상수 정의 통합 | 중간 | 2시간 | - |
| 설정 파일 업데이트 | 중간 | 1시간 | - |
| 연결 및 구독 테스트 | 높음 | 2시간 | - |
| 메시지 처리 테스트 | 높음 | 2시간 | - |
| 성능 및 안정성 테스트 | 높음 | 3시간 | - |

### 6.4. 웹소켓 매니저 개선

| 작업 | 우선순위 | 예상 소요 시간 | 담당 |
|------|----------|----------------|------|
| 메시지 큐 처리 최적화 | 중간 | 4시간 | - |
| 연결 상태 관리 개선 | 중간 | 3시간 | - |
| 메트릭 관리 개선 | 중간 | 5시간 | - |
| 메모리 사용량 최적화 | 낮음 | 4시간 | - |
| 알림 시스템 연동 강화 | 낮음 | 3시간 | - |

## 7. 구현 일정

| 단계 | 작업 내용 | 예상 소요 일수 | 시작일 | 종료일 |
|------|-----------|----------------|--------|--------|
| 1 | 코드 분석 및 중복 코드 식별 | 1일 | - | - |
| 2 | `BaseWebsocket` 클래스 개선 | 1일 | - | - |
| 3 | 웹소켓 상태 관리 클래스 개선 | 0.5일 | - | - |
| 4 | 재연결 전략 개선 | 0.5일 | - | - |
| 5 | 바이빗 현물 V2 통합 | 1일 | - | - |
| 6 | 바이빗 선물 V2 통합 | 1일 | - | - |
| 7 | 웹소켓 매니저 개선 | 1일 | - | - |
| 8 | 거래소별 구현 표준화 | 1일 | - | - |
| 9 | 통합 테스트 및 안정화 | 1일 | - | - |
| 10 | 문서화 및 코드 정리 | 0.5일 | - | - |

## 8. 결론 및 기대 효과

| 항목 | 현재 상태 | 개선 후 기대 효과 |
|------|-----------|-------------------|
| 코드 중복 | 높음 | 50% 이상 감소 |
| 유지보수성 | 중간 | 크게 향상 |
| 안정성 | 중간 | 웹소켓 연결 끊김 50% 감소 |
| 성능 | 중간 | 메시지 처리 지연 20% 감소 |
| 메모리 사용량 | 높음 | 15% 이상 감소 |
| 모니터링 | 기본 | 실시간 문제 감지 및 알림 |
| 확장성 | 제한적 | 새로운 거래소 추가 용이 | 