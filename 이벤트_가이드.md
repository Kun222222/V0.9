# 크로스킴프 시스템 이벤트 가이드

이 문서는 `obcollector_handler.py`와 `process_component.py`에서 발행하는 이벤트 타입들을 정리한 가이드입니다. 이벤트 구독 시스템을 사용하여 컴포넌트 간 통신 및 알림을 처리할 때 참조하세요.

## 목차

1. [이벤트 시스템 개요](#이벤트-시스템-개요)
2. [프로세스 컴포넌트 이벤트](#프로세스-컴포넌트-이벤트)
3. [오더북 수집기 이벤트](#오더북-수집기-이벤트)
4. [이벤트 데이터 형식](#이벤트-데이터-형식)
5. [사용 예시](#사용-예시)

## 이벤트 시스템 개요

크로스킴프 시스템은 비동기 이벤트 기반 아키텍처를 사용합니다. 각 컴포넌트는 이벤트 버스를 통해 상태 변경을 알리고, 다른 컴포넌트는 이러한 이벤트를 구독하여 반응합니다. 이벤트 경로는 계층 구조로 이루어져 있어 카테고리화가 용이합니다.

## 프로세스 컴포넌트 이벤트

`process_component.py` 모듈에서는 다음 이벤트들을 발행합니다:

### 프로세스 상태 이벤트

| 이벤트 경로 | 설명 | 발행 시점 |
|------------|------|----------|
| `process/status` | 프로세스 상태 변경 | 프로세스 상태가 변경될 때마다 발행 |
| `process/error` | 프로세스 오류 | 프로세스에서 오류 발생 시 발행 |

### 프로세스 상태 값

프로세스 상태 이벤트의 `status` 필드에 사용되는 값:

| 상태 값 | 설명 |
|--------|------|
| `process/stopped` | 프로세스 중지됨 |
| `process/starting` | 프로세스 시작 중 |
| `process/running` | 프로세스 실행 중 |
| `process/stopping` | 프로세스 종료 중 |
| `process/error` | 프로세스 오류 상태 |

### 프로세스 이벤트 타입

프로세스 상태 이벤트의 `event_type` 필드에 사용되는 값:

| 이벤트 타입 | 설명 |
|------------|------|
| `process/start_requested` | 프로세스 시작 요청됨 |
| `process/started` | 프로세스 시작됨 |
| `process/stop_requested` | 프로세스 중지 요청됨 |
| `process/stopped` | 프로세스 중지됨 |
| `process/restart_requested` | 프로세스 재시작 요청됨 |
| `process/error` | 프로세스 오류 발생 |

## 오더북 수집기 이벤트

`obcollector_handler.py` 모듈에서는 다음 이벤트들을 발행합니다:

| 이벤트 경로 | 설명 | 발행 시점 |
|------------|------|----------|
| `component/ob_collector/running` | 오더북 수집기 구동 완료 | 모든 거래소 연결이 완료되었을 때 |
| `component/ob_collector/connection_lost` | 오더북 수집기 연결 끊김 | 하나 이상의 거래소 연결이 끊겼을 때 |
| `component/ob_collector/exchange_status` | 거래소 상태 변경 | 거래소 연결 상태가 변경되었을 때 |

추가로 `metric/reporter.py`를 통해 발행되는 메트릭 이벤트들:

| 이벤트 경로 | 설명 |
|------------|------|
| `component/ob_collector/connection` | 연결 메트릭 |
| `component/ob_collector/message` | 메시지 메트릭 |
| `component/ob_collector/error` | 오류 메트릭 |
| `component/ob_collector/system` | 시스템 메트릭 |
| `component/ob_collector/subscription` | 구독 메트릭 |

## 이벤트 데이터 형식

### 프로세스 상태 이벤트 데이터

```python
{
    "process_name": str,         # 프로세스 이름 (예: "ob_collector")
    "status": str,               # 프로세스 상태 값
    "event_type": str,           # 이벤트 타입
    "error_message": str,        # [선택] 오류 메시지 (오류 발생 시에만)
    "details": dict,             # [선택] 추가 상세 정보
    "timestamp": float           # 이벤트 발생 시간 (UNIX 타임스탬프)
}
```

### 오더북 구동 완료 이벤트 데이터

```python
{
    "process_name": str,         # 프로세스 이름 (예: "ob_collector")
    "message": str,              # 알림 메시지
    "details": {
        "exchanges": [           # 거래소 정보 리스트
            {
                "name": str,            # 거래소 코드명 (예: "upbit")
                "display_name": str,    # 거래소 표시명 (예: "업비트")
                "connected": bool,      # 연결 상태
                "uptime_seconds": float, # 업타임 (초)
                "uptime_formatted": str  # 가독성 있는 업타임
            },
            # ...
        ],
        "connected_count": int,  # 연결된 거래소 수
        "total_count": int,      # 총 거래소 수
        "all_connected": bool    # 모든 거래소 연결 여부
    },
    "timestamp": float           # 이벤트 발생 시간 (UNIX 타임스탬프)
}
```

### 메트릭 이벤트 데이터 (일반)

```python
{
    "process_id": str,           # 컴포넌트 ID
    "timestamp": float,          # 발행 시간
    "metric_type": str,          # 메트릭 타입 (connection, message, error 등)
    "metrics": dict              # 메트릭 데이터 (메트릭 타입에 따라 형식 다름)
}
```

## 사용 예시

### 이벤트 구독 예시

```python
from crosskimp.common.events.system_eventbus import get_event_bus
from crosskimp.common.events.system_types import EventPaths

# 이벤트 버스 가져오기
event_bus = get_event_bus()

# 오더북 구동 완료 이벤트 구독
async def on_ob_collector_running(data):
    print(f"오더북 수집기 구동 완료: {data['message']}")
    # 데이터 처리 로직...

# 이벤트 핸들러 등록
event_bus.register_handler(EventPaths.OB_COLLECTOR_RUNNING, on_ob_collector_running)
```

### 이벤트 발행 예시

```python
from crosskimp.common.events.system_eventbus import get_event_bus
from crosskimp.common.events.system_types import EventPaths

# 이벤트 버스 가져오기
event_bus = get_event_bus()

# 이벤트 데이터 생성
event_data = {
    "process_name": "my_process",
    "status": EventPaths.PROCESS_STATUS_RUNNING,
    "event_type": "process/started",
    "details": {"key": "value"}
}

# 이벤트 발행
await event_bus.publish(EventPaths.PROCESS_STATUS, event_data)
```

© 크로스킴프 아비트리지 시스템