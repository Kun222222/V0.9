# 크로스 김프 차익거래 시스템 리팩토링 계획

## 개요

이 문서는 크로스 김프 차익거래 시스템의 리팩토링 계획을 상세히 설명합니다. 현재 시스템은 여러 거래소(바이낸스, 바이비트, 업비트, 빗썸)의 웹소켓을 통해 실시간 시장 데이터를 수집하고, 김프 차익거래 기회를 모니터링하는 복잡한 시스템입니다. 리팩토링을 통해 코드 품질, 유지보수성, 확장성, 안정성을 향상시키는 것이 목표입니다.

## 현재 시스템 구조

현재 시스템은 다음과 같은 구조로 리팩토링이 진행 중입니다:

```
src/
├── crosskimp/                      # 메인 패키지
│   ├── config/                     # 설정 관리
│   │   ├── config_loader.py        # 설정 로더
│   │   ├── api_keys.json           # API 키 설정
│   │   └── settings.json           # 시스템 설정
│   │
│   ├── core/                       # 핵심 비즈니스 로직
│   │   ├── aggregator.py           # 데이터 집계
│   │   ├── market_price_monitor.py # 시장 가격 모니터
│   │   └── usdt_krw_monitor.py     # USDT/KRW 모니터
│   │
│   ├── orderbook/                  # 오더북 관련
│   │   ├── common/                 # 공통 컴포넌트
│   │   ├── manager/                # 매니저 컴포넌트
│   │   │   └── websocket_metrics_manager.py # 웹소켓 메트릭 매니저
│   │   ├── orderbook/              # 오더북 구현
│   │   │   ├── base_orderbook.py   # 기본 오더북
│   │   │   ├── base_orderbook_manager.py # 기본 오더북 매니저
│   │   │   └── [exchange]_[type]_orderbook_manager.py # 거래소별 구현
│   │   └── websocket/              # 웹소켓 구현
│   │       ├── base_websocket.py   # 기본 웹소켓
│   │       ├── websocket_manager.py # 웹소켓 매니저
│   │       └── [exchange]_[type]_websocket.py # 거래소별 구현
│   │
│   ├── server/                     # 서버 관련
│   │   ├── api/                    # API 서비스
│   │   ├── backend/                # 백엔드 서비스
│   │   │   ├── metrics_collector.py # 메트릭 수집기
│   │   │   └── monitor_server.py   # 모니터링 서버
│   │   └── frontend/               # 프론트엔드
│   │
│   ├── utils/                      # 유틸리티
│   │   └── logging/                # 로깅 시스템
│   │       └── logger.py           # 로거 구현
│   │
│   └── main.py                     # 메인 진입점
│
├── telegrambot/                    # 텔레그램 봇 모듈
│   └── notification/               # 알림 기능
│       └── telegram_bot.py         # 텔레그램 봇 구현
│
├── log/                            # 로그 관련
│
└── script/                         # 유틸리티 스크립트
```

## 리팩토링 작업 진척 현황

### 1단계: 기반 구조 개선 (1-2주)

- [x] **폴더 구조 재구성**
  - [x] 새로운 폴더 구조 생성
  - [x] 기존 코드 새 구조로 이동 (기능 변경 없이)
  - [x] 기본 `__init__.py` 파일 추가

- [ ] **인터페이스 정의**
  - [ ] 웹소켓 클라이언트 인터페이스 정의
  - [ ] 오더북 인터페이스 정의
  - [ ] 오더북 매니저 인터페이스 정의

- [ ] **의존성 주입 패턴 적용**
  - [ ] 로거 주입 구조 개선
  - [ ] 설정 주입 구조 개선
  - [ ] HTTP/웹소켓 세션 주입 구조 개선

- [ ] **설정 관리 개선**
  - [x] 설정 파일 구조화 (settings.json, api_keys.json)
  - [ ] 설정 클래스 구현
  - [ ] 설정 검증 로직 추가
  - [ ] 민감 정보 보호 메커니즘 구현

### 2단계: 핵심 기능 리팩토링 (2-3주)

- [ ] **웹소켓 모듈 개선**
  - [x] 기본 웹소켓 클래스 구현
  - [x] 거래소별 웹소켓 구현
  - [ ] 재연결 및 오류 처리 메커니즘 개선

- [ ] **오더북 모듈 개선**
  - [x] 기본 오더북 클래스 구현
  - [x] 거래소별 오더북 구현
  - [ ] 데이터 검증 및 무결성 확인 강화

- [ ] **오더북 매니저 개선**
  - [x] 기본 오더북 매니저 구현
  - [x] 거래소별 오더북 매니저 구현
  - [ ] 스냅샷 및 델타 처리 로직 개선

- [ ] **집계 모듈 개선**
  - [x] 데이터 집계 로직 구현
  - [ ] 차익거래 기회 감지 알고리즘 개선
  - [ ] 성능 최적화

### 3단계: 모니터링 및 안정성 강화 (1-2주)

- [ ] **메트릭 수집 개선**
  - [x] 웹소켓 메트릭 매니저 구현
  - [x] 메트릭 수집기 구현
  - [ ] Prometheus 호환 형식 지원
  - [ ] 주요 성능 지표 정의 및 수집

- [ ] **알림 시스템 강화**
  - [x] 텔레그램 봇 구현
  - [ ] 알림 조건 및 임계값 설정 기능
  - [ ] 알림 그룹화 및 중복 방지

- [ ] **로깅 시스템 개선**
  - [x] 기본 로거 구현
  - [ ] 구조화된 로깅 구현
  - [ ] 로그 레벨별 필터링 및 라우팅
  - [ ] 로그 파일 관리 자동화

- [ ] **오류 처리 및 복구 메커니즘 강화**
  - [ ] 예외 계층 구조 정의
  - [ ] 복구 가능/불가능한 오류 구분
  - [ ] 자동 복구 전략 구현

### 4단계: 성능 최적화 (1-2주)

- [ ] **비동기 처리 최적화**
  - [ ] 불필요한 `await` 제거
  - [ ] 비동기 작업 그룹화 및 병렬 처리
  - [ ] 비동기 컨텍스트 관리 개선

- [ ] **메모리 사용량 최적화**
  - [ ] 메트릭 데이터 보관 기간 제한
  - [ ] 주기적 메모리 정리 로직 구현
  - [ ] 대용량 데이터 처리 최적화

- [ ] **리소스 관리 개선**
  - [ ] 연결 풀 및 세션 관리 개선
  - [ ] 비동기 작업 제한 및 조절
  - [ ] 시스템 리소스 모니터링 강화

### 5단계: API 및 프론트엔드 개선 (1-2주)

- [ ] **API 서비스 개선**
  - [x] 기본 API 구조 설정
  - [ ] API 엔드포인트 표준화
  - [ ] API 문서화 (Swagger/OpenAPI)

- [ ] **프론트엔드 개선**
  - [x] 기본 프론트엔드 구조 설정
  - [ ] 대시보드 UI/UX 개선
  - [ ] 실시간 데이터 시각화 강화
  - [ ] 사용자 정의 대시보드 지원

### 6단계: 테스트 및 문서화 (1-2주)

- [ ] **테스트 추가**
  - [ ] 단위 테스트 구현
  - [ ] 통합 테스트 구현
  - [ ] 성능 테스트 구현

- [ ] **문서화**
  - [ ] API 문서화
  - [ ] 컴포넌트 문서화
  - [ ] 설치 및 운영 가이드 작성

- [ ] **배포 자동화**
  - [ ] CI/CD 파이프라인 구성
  - [ ] 배포 스크립트 작성
  - [ ] 환경별 설정 관리

## 다음 작업 우선순위

### 수정된 우선순위: 기본 구조 및 진입점 정리

1. **메인 진입점 및 기본 파일 정리**
   - `main.py` 파일 리팩토링
     - 명확한 초기화 및 시작 로직 구현
     - 비동기 컨텍스트 관리 개선
     - 종료 처리 로직 강화
   - 설정 로딩 및 관리 개선
     - `config_loader.py` 리팩토링
     - 환경 변수 지원 추가
   - 로깅 시스템 기본 구조 개선
     - 로그 레벨 및 포맷 표준화
     - 로그 파일 관리 자동화

2. **핵심 모듈 간 의존성 정리**
   - 모듈 간 순환 참조 제거
   - 명확한 의존성 방향 설정
   - 핵심 컴포넌트 간 인터페이스 정의

3. **설정 관리 개선**
   - 설정 클래스 구현
   - 설정 검증 로직 추가
   - 민감 정보 보호 메커니즘 구현

4. **인터페이스 정의**
   - 웹소켓 클라이언트 인터페이스 정의
   - 오더북 인터페이스 정의
   - 오더북 매니저 인터페이스 정의

5. **의존성 주입 패턴 적용**
   - 로거 주입 구조 개선
   - 설정 주입 구조 개선
   - HTTP/웹소켓 세션 주입 구조 개선

### 구체적인 작업 계획

1. **메인 진입점 리팩토링**
   - 비동기 컨텍스트 관리 개선
   ```python
   # main.py
   async def main():
       # 초기화 로직
       config = await load_config()
       logger = setup_logging(config)
       
       # 컴포넌트 초기화
       components = await initialize_components(config, logger)
       
       # 시그널 핸들러 설정
       setup_signal_handlers(components)
       
       # 메인 루프 실행
       try:
           await run_main_loop(components)
       finally:
           # 정리 로직
           await cleanup(components)
   
   if __name__ == "__main__":
       asyncio.run(main())
   ```

2. **설정 관리 개선**
   - 설정 클래스 구현
   ```python
   # config/settings.py
   from dataclasses import dataclass
   from typing import Dict, List, Optional
   import json
   import os
   
   @dataclass
   class WebSocketConfig:
       reconnect_delay: float = 1.0
       max_reconnect_attempts: int = 5
       ping_interval: int = 30
       
   @dataclass
   class Settings:
       websocket: WebSocketConfig
       exchanges: Dict[str, Dict]
       log_level: str
       
       @classmethod
       def from_file(cls, file_path: str) -> 'Settings':
           with open(file_path, 'r') as f:
               data = json.load(f)
           
           return cls(
               websocket=WebSocketConfig(**data.get('websocket', {})),
               exchanges=data.get('exchanges', {}),
               log_level=data.get('log_level', 'INFO')
           )
   ```

3. **로깅 시스템 개선**
   - 로거 팩토리 구현
   ```python
   # utils/logging/logger_factory.py
   import logging
   from typing import Optional
   
   def create_logger(name: str, log_level: str = 'INFO', log_file: Optional[str] = None) -> logging.Logger:
       logger = logging.getLogger(name)
       logger.setLevel(getattr(logging, log_level))
       
       # 콘솔 핸들러
       console_handler = logging.StreamHandler()
       console_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
       logger.addHandler(console_handler)
       
       # 파일 핸들러 (옵션)
       if log_file:
           file_handler = logging.FileHandler(log_file)
           file_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
           logger.addHandler(file_handler)
           
       return logger
   ```

## 세부 개선 사항

### 웹소켓 모듈 개선

1. **인터페이스 분리**
   - 웹소켓 클라이언트, 오더북, 오더북 매니저 인터페이스 명확히 분리
   - 각 거래소별 구현을 인터페이스 기반으로 표준화

2. **의존성 주입 패턴 적용**
   - 로거, 설정, 세션 등을 외부에서 주입받도록 변경
   - 테스트 용이성 및 유연성 향상

3. **에러 처리 강화**
   - 예외 계층 구조 정의 (네트워크 오류, 파싱 오류, 비즈니스 로직 오류 등)
   - 복구 가능/불가능한 오류 구분 및 처리 전략 수립

### 설정 관리 개선

1. **설정 클래스**
   - 타입 안전성이 보장된 설정 클래스 구현
   - 기본값 및 검증 로직 포함

2. **설정 검증**
   - 필수 설정 확인 및 유효성 검증
   - 오류 메시지 명확화

### 로깅 시스템 개선

1. **구조화된 로깅**
   - JSON 형식 로그 지원
   - 컨텍스트 정보 포함

2. **로거 팩토리**
   - 일관된 로거 생성 및 설정
   - 컴포넌트별 로거 분리

### 메트릭 수집 개선

1. **메트릭 수집기**
   - 카운터, 게이지, 히스토그램 등 다양한 메트릭 유형 지원
   - 태그 기반 메트릭 관리

### 경로 관리 개선

1. **절대 경로 사용**
   - 상대 경로 대신 절대 경로 사용으로 이식성 향상
   - 프로젝트 루트 기준 경로 관리 유틸리티 구현

2. **경로 설정 중앙화**
   - 모든 경로 상수를 중앙 모듈에서 관리
   - 환경별 경로 설정 지원 (개발, 테스트, 프로덕션)

3. **동적 경로 해결**
   - 실행 환경에 따른 경로 자동 감지 및 설정
   - 설정 파일을 통한 경로 오버라이드 지원

4. **플랫폼 독립적 경로 처리**
   - OS별 경로 구분자 차이 자동 처리
   - 다양한 운영체제 환경 지원 (Windows, Linux, macOS)

### 패키지 구조 개선

1. **모듈 간 의존성 명확화**
   - `__init__.py` 파일을 통한 패키지 인터페이스 정의
   - 명시적 임포트 및 의존성 관리

2. **패키지 계층 구조 최적화**
   - 기능별 패키지 분리 (crosskimp, telegrambot, script, log)
   - 각 패키지 내부 구조 표준화

3. **진입점 단순화**
   - 명확한 진입점 제공 (`main.py`)
   - 모듈 재사용성 향상

## 기대 효과

1. **유지보수성 향상**
   - 명확한 코드 구조와 책임 분리로 유지보수 용이성 증가
   - 일관된 코딩 패턴 및 문서화로 개발자 온보딩 시간 단축

2. **확장성 개선**
   - 새로운 거래소 추가 용이
   - 새로운 기능 통합 용이성 향상

3. **안정성 강화**
   - 오류 처리 및 복구 메커니즘 개선으로 시스템 안정성 향상
   - 모니터링 및 알림 시스템 강화로 문제 조기 발견

4. **성능 최적화**
   - 비동기 처리 최적화로 처리량 증가
   - 메모리 사용량 최적화로 리소스 효율성 향상

5. **개발 생산성 향상**
   - 테스트 용이성 향상으로 개발 사이클 단축
   - 명확한 인터페이스 및 문서화로 협업 효율성 증가

6. **이식성 향상**
   - 절대 경로 사용으로 다양한 환경에서 일관된 동작 보장
   - 환경 설정 분리로 개발, 테스트, 프로덕션 환경 전환 용이

## 결론

이 리팩토링 계획은 크로스 김프 차익거래 시스템의 코드 품질, 유지보수성, 확장성, 안정성을 크게 향상시킬 것입니다. 단계적 접근 방식을 통해 기존 기능을 유지하면서 점진적으로 시스템을 개선할 수 있습니다. 각 단계는 독립적으로 완료될 수 있으며, 필요에 따라 우선순위를 조정할 수 있습니다.

현재 1단계의 폴더 구조 재구성과 기본 `__init__.py` 파일 추가가 완료되었으며, 핵심 기능의 기본 구현도 상당 부분 진행되었습니다. 다음 단계로는 메인 진입점 및 기본 파일 정리, 모듈 간 의존성 정리, 설정 관리 개선에 집중할 예정입니다. 이러한 기본 구조 개선 후에 웹소켓 및 오더북 관련 인터페이스 정의와 의존성 주입 패턴 적용을 진행할 것입니다.

리팩토링 작업은 약 8-12주에 걸쳐 진행될 것으로 예상되며, 각 단계가 완료될 때마다 철저한 테스트를 통해 기능 정상 작동을 확인해야 합니다. 또한, 리팩토링 과정에서 발견되는 버그나 개선 사항을 지속적으로 반영하여 시스템의 품질을 향상시켜 나갈 것입니다.
